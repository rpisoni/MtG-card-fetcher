<link rel="import" href="@polymer/polymer/polymer.html" />

<dom-module id="mtg-card-fetcher">
    <script src="page/page.js"></script>
    <script>
        (function ()    {
            //page('/', changeView("search"));
            page('/:view', function (context, next)    {
                context.handled = true;
                changeView(context.params.view);
                next();
            });
            function changeView(viewName)   {
                console.log(viewName);
                document.getElementsByTagName('mtg-card-fetcher')[0].setAttribute('view', viewName);
            }
            page.start();
        })();
    </script>
    <template>
        <style>
            /*ADD STYLES HERE*/
        </style>
        <div class="component-container">
            <div class="menu-container">
                <a href="{{baseUrl}}search">
                    <span>Search</span>
                </a>
                <a href="{{baseUrl}}deck">
                    <span>Deck Builder</span>
                </a>
                <a href="{{baseUrl}}draft">
                    <span>Draft</span>
                </a>
            </div>
            <hr />
            <div class="content">
                <template is="dom-if" if="[[_viewIsSearch(view)]]">
                    <div class="search-bar">
                        <h1>MTG Card Fetcher</h1>
                        <form id="search-form" on-submit="_searchCardsByName">
                            <input type="text" id="sf" placeholder="Enter a card name here!">
                            <button id="fetch" on-tap="_searchCardsByName">Fetch</button>
                        </form>
                        <hr />
                    </div>
                    <template is="dom-if" if="[[loading_]]">
                        <p>Nothing To Display</p>
                    </template>
                    <template is="dom-if" if="[[ready_]]">
                        <table id="card-list">
                            <template is="dom-repeat" items="[[cards]]">
                                <tr>
                                    <td>
                                        <img src="[[item.editions.0.image_url]]" alt="[[item.name]]" />
                                    </td>
                                    <td>
                                        <h2>[[item.name]]</h2>
                                    </td>
                                </tr>
                            </template>
                        </table>
                    </template>
                    <template is="dom-if" if="[[error_]]">
                        <h1>AN ERROR HAS OCCURED</h1>
                    </template>
                </template>
                <template is="dom-if" if="{{_viewIsDeck(view)}}">
                    <h1>Deck Builder</h1>
                    <table id="decklist">
                        <template is="dom-repeat" items="[[findCardsInDeck(deck)]]">
                            <tr>
                                <td>
                                    <img src="[[item.editions.0.image_url]]" alt="[[item.name]]" />
                                </td>
                            </tr>
                        </template>
                    </table>
                </template>
                <template is="dom-if" if="{{_viewIsDraft(view)}}">
                    <h1>Draft Simulator</h1>
                </template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "mtg-card-fetcher",
           
            properties: {
                search: {
                    type: String,
                    value: ""
                },
                
                cards:  {
                    type: Object
                },
                
                deck:   {
                    type: Array,
                    value: [393908, 235597, 259695]
                },
                
                view:   {
                    type: String,
                    default: "search"  
                },
                
                loading_:   {
                    type: Boolean,
                    value: false
                },
                
                ready_: {
                    type: Boolean,
                    value: false
                },
                
                error_: {
                    type: Boolean,
                    value: false
                }
            }, 
            
            listeners:  {
                //"fetch.click": 'searchCardsByName'
            },
           
            attached: function() {
                console.log("attached");
                console.log(this.deck);
                this.loadCards_();
                
            },
            
            _searchCardsByName: function(e) {
                e.preventDefault();
                console.log(this.$$('#sf').value);
                this.search = "name=" + this.$$('#sf').value;
                this.loadCards_();
                
            },
           
            loadCards_: function ()   {
                var self = this;
                var xhr = new XMLHttpRequest();
                //xhr.open("GET", "https://api.deckbrew.com/mtg/cards?" + this.search, true);
                xhr.open("GET", "https://api.deckbrew.com/mtg/cards?name=lightning", true)
               
                xhr.onload = function(evt)   {
                    if(xhr.status === 200)   {
                        self.cards = JSON.parse(xhr.responseText);
                        console.log(self.cards);
                        self.loading_ = false;
                        self.ready_ = true;
                    } else  {
                        self.error_ = true;
                        self.loading_ = false;
                        self.ready_ = false;   
                    }
                };
                xhr.send();
            },
            
            findCardsInDeck: function(d)    {
                var decklist = [];
                
                for(var i = 0; i < d.length; i++)   {
                    decklist.push(this.loadDeckCards(d[i]));   
                    console.log(decklist); 
                }
                
                return decklist;
            },
            
            loadDeckCards: function(d)  {
                var self = this;
                var xhr = new XMLHttpRequest();
                var card;
                
                xhr.open("GET", "https://api.deckbrew.com/mtg/cards?multiverseid=" + d, true);
                
                xhr.onload = function(evt)   {
                    if(xhr.status === 200)   {
                        card = JSON.parse(xhr.responseText);
                        console.log(card);
                        return card;
                    } else  {
                        self.error_ = true;
                        self.loading_ = false;
                        self.ready_ = false;   
                    }
                };
                
                xhr.send();
            },
            
            _viewIsSearch: function (v)  {
                return v === 'search';
            },
            
            _viewIsDeck: function (v)  {
                return v === 'deck';
            },
            
            _viewIsDraft: function (v)  {
                return v === 'draft';
            }
        });
    </script>
</dom-module>
        