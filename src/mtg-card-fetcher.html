<link rel="import" href="@polymer/polymer/polymer.html" />

<dom-module id="mtg-card-fetcher">
    
    
    <template>
        <style>
            .loader,
            .loader:before,
            .loader:after {
                background: #c8c8c8;
                -webkit-animation: load1 1s infinite ease-in-out;
                animation: load1 1s infinite ease-in-out;
                width: 1em;
                height: 4em;
            }
            .loader:before,
            .loader:after {
                position: absolute;
                top: 0;
                content: '';
            }
            .loader:before {
                left: -1.5em;
                -webkit-animation-delay: -0.32s;
                animation-delay: -0.32s;
            }
            .loader {
                color: #c8c8c8;
                text-indent: -9999em;
                margin: 88px auto;
                position: relative;
                font-size: 11px;
                -webkit-transform: translateZ(0);
                -ms-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-animation-delay: -0.16s;
                animation-delay: -0.16s;
            }
            .loader:after {
                left: 1.5em;
            }
            @-webkit-keyframes load1 {
                0%,
                80%,
                100% {
                    box-shadow: 0 0;
                    height: 4em;
                }
                40% {
                    box-shadow: 0 -2em;
                    height: 5em;
                }
            }
            @keyframes load1 {
                0%,
                80%,
                100% {
                    box-shadow: 0 0;
                    height: 4em;
                }
                40% {
                    box-shadow: 0 -2em;
                    height: 5em;
                }
            }
            a {
                color: rgb(220,220,220);
            }
            table {
                width: 100%;
            }
            #search-table td:nth-child(1) {
                width: 10%;
            }
            #search-table td:nth-child(2) {
                width: 90%;
            }
            #advanced-table td:nth-child(1) {
                width: 10%;
            }
            #advanced-table td:nth-child(2) {
                width: 90%;
            }
            #deck-container {
                width: 75%;
                float: left;
            }
            div.deck-card {
                height: 350px;
                margin: 15px;
                float: left;
            }
            #deck-stats {
                width: 25%;
                position: fixed;
                left: 73%;
                vertical-align: top;
                margin:10px;
                background-color: rgb(80, 80, 80);
            }
            div.card-description-container {
                margin: 10px;
                padding: 5px;
                background-color: rgba(89, 63, 7, 0.5);
            }
            div.card-description-container-gold {
                margin: 10px;
                padding: 5px;
                background-color: rgba(191, 163, 22, 0.68);
            }
            div.card-description-container-white {
                margin: 10px;
                padding: 5px;
                background-color: rgb(100, 100, 100);
            }
            div.card-description-container-blue {
                margin: 10px;
                padding: 5px;
                background-color: rgba(71, 117, 163, 0.68);
            }
            div.card-description-container-black {
                margin: 10px;
                padding: 5px;
                background-color: rgba(10, 10, 10, 0.75);
            }
            div.card-description-container-red {
                margin: 10px;
                padding: 5px;
                background-color: rgba(163, 71, 71, 0.68);
            }
            div.card-description-container-green {
                margin: 10px;
                padding: 5px;
                background-color: rgba(117, 163, 71, 0.68);
            }
            div.card-text-container {
                margin: 10px;
                padding: 5px;
                background-color: rgb(125, 125, 125);
            }
            div.card-data-container {
                font-size: 12px;
            }
            span.card-text {
                font-weight: bold;
            }
            div.card-flavor-container {
                margin: 10px;
                padding: 5px;
                background-color: rgb(125, 125, 125);
            }
            span.card-flavor {
                font-style: italic;
            }
            .card-table td:nth-child(1) {
                width: 15%;
                vertical-align: top;
            }
            .card-table td:nth-child(2) {
                width: 60%;
            }
            .card-table td:nth-child(3) {
                width: 25%;
                vertical-align: top;
                
            }
            button.add-to-deck {
                border-radius: 4px;
                border: none;
                padding: 6px 11px;
                border: none;
                color: #242424;
                margin: 10px;
            }
            #toggle-form {
                margin: 10px;
            }
            div.booster-card {
                height: 350px;
                margin: 15px;
                float: left;
            }
            #booster-container {
                width: 100%;
                float: left;
            }
            div.picks-card {
                height: 350px;
                margin: 15px;
                float: left;
            }
            #picks-container {
                width: 100%;
                float: left;
            }

            nav {
                background-color: rgb(20, 20, 20);
                width: 100%;
                
            }

            nav.menu-container .nav-header {
                float: left;
            }

            nav.menu-container button {
                background-color: transparent;
                border: none;
                float: left;
                padding: 20px 20px;
            }

            nav.menu-container button a {
                text-decoration: none;
                font-size: 18px;
            }

            nav.menu-container button a:hover {
                color: white;
            }

            nav.menu-container .nav-list ul {
                list-style-type: none;
                margin: 0;
                padding: 0;
                overflow: hidden; 
            }

            nav.menu-container .nav-list li {
                float: left;
                overflow: auto;
            }

            nav.menu-container .nav-list li a {
                display: block;
                padding: 20px;
                text-align: center;
                text-decoration: none;
            }

            nav.menu-container .nav-list li a:hover {
                color: white;
            }
            #content {
                margin-top: 40px;
                padding-right: 15px;
                padding-left: 15px;
                margin-left: auto;
                margin-right: auto;
            }
            .search-div {
                background-color: rgb(80, 80, 80);
                transition: visibility 2s, opacity 0.5s linear;
            }
            #search-form {
                padding: 5px;
            }
            .pretty-input {
                border-radius: 5px;
                border: 1px solid #ccc;
                height: 1.5em;
                padding: 4px;
                background-color: #ffffff;
                color: #555555;
                box-shadow: none;
            }

            .pretty-input:focus {
                border-radius: 5px;
                border: 1px solid lightblue;
                box-shadow: 0px 0px 8px purple;
                outline: none;
                outline-offset: 0px;
            }
            .pretty-button {
                border-radius: 4px;
                border: none;
                padding: 6px 11px;
                border: none;
                color: #242424;
            }

            .pretty-button:hover {
                color: #ffffff;
            }
            
            .pretty-button:focus {
                outline: none;
                box-shadow: 0px 0px 8px purple;
            }

            .pretty-dropdown {
                text-align: center;
                padding: 6px 8px;
                border-radius: 4px;
                
            }
            .pretty-dropdown:focus {
                outline: none;
                box-shadow: 0px 0px 8px purple;
            }
            #add-remove{
                text-align: center;
            }
            #button-wrap{
                text-align: center;
                margin: 10px;
            }
            .component-container {
                margin-top:100px;
            }
            #draft-form {
                background-color: rgb(80, 80, 80);
                padding: 5px;
            }
        </style>
        <div class="component-container">
            <div id="content">
                <!-- 
                    -------------------
                        SEARCH VIEW
                    ------------------- 
                                       --->
                <template is="dom-if" if="[[_viewIsSearch(view)]]">
                    <div class="search-div">
                        <form id="search-form" on-submit="_searchForCards">
                            <table id = "search-table">
                                <tr>
                                    <td>
                                        <label for="search-field">Card Name: </label>
                                    </td>
                                    <td>
                                        <input type="text" class="pretty-input" id="search-field" placeholder="Enter a card name here!">
                                        <button class="pretty-button" id="fetch" on-tap="_searchForCards">Fetch</button>
                                    </td>
                                </tr>
                            </table>
                            <div id="advanced-div" style="display:none;">
                                <table id="advanced-table">
                                    <tr>
                                        <td>
                                            <label for="rules-text">Rules Text: </label>
                                        </td>
                                        <td>
                                            <input type="text" class="pretty-input" id="rules-text">    
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="super-type">Super-Type: </label></td>
                                        <td><input type="text" class="pretty-input" id="super-type"></td>
                                    </tr>
                                    <tr>
                                        <td><label for="card-type">Type: </label></td>
                                        <td><input type="text" class="pretty-input" id="card-type"></td>
                                    </tr>
                                    <tr>
                                        <td><label for="sub-type">Sub-Type: </label></td>
                                        <td><input type="text" class="pretty-input" id="sub-type"></td>
                                    </tr>
                                    <tr>
                                        <td>Colors: </td>
                                        <td>
                                            <label><input type="checkbox" id="color-white" value="white"> White</label>
                                            <label><input type="checkbox" id="color-blue" value="blue"> Blue</label>
                                            <label><input type="checkbox" id="color-black" value="black"> Black</label>
                                            <label><input type="checkbox" id="color-red" value="red"> Red</label>
                                            <label><input type="checkbox" id="color-green" value="green"> Green</label>
                                            <br>
                                            (<label><input type="checkbox" id="color-multi" value="true"> Multi-Color)</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Rarity:</td>
                                        <td>
                                            <label><input type="checkbox" id="rarity-mythic" value="mythic"> Mythic</label>
                                            <label><input type="checkbox" id="rarity-rare" value="rare"> Rare</label>
                                            <label><input type="checkbox" id="rarity-uncommon" value="uncommon"> Uncommon</label>
                                            <label><input type="checkbox" id="rarity-common" value="Common"> Common</label>
                                            <label><input type="checkbox" id="rarity-basic" value="basic"> Basic Land</label>
                                            <label><input type="checkbox" id="rarity-special" value="special"> Special</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="set">Set:</label></td>
                                        <td>
                                            <input type="text" class="pretty-input" id="set" placeholder="Shorthand Identifier">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="format-select">Format: </label></td>
                                        <td>
                                            <select class="pretty-dropdown" id="format-select">
                                                <option value="">All Formats</option>
                                                <option value="standard">Standard</option>
                                                <option value="modern">Modern</option>
                                                <option value="legacy">Legacy</option>
                                                <option value="vintage">Vintage</option>
                                                <option value="commander">Commander</option>
                                            </select>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <table>
                            <button class="pretty-button" id="toggle-form" on-tap="_toggleForm">Toggle Advanced Search</button>
                        </form>
                    </div>
                    <template is="dom-if" if="[[loading_]]">
                        <div class="loader">LOADING...</div>
                    </template>
                    <template is="dom-if" if="[[ready_]]">
                        <template is ="dom-if" if="[[cardsIsEmpty(cards)]]">
                            <span>No Results to display</span>
                        </template>
                        <template is ="dom-if" if="[[!cardsIsEmpty(cards)]]">
                            <span>Number of Results: [[getNumResults(cards)]]</span>
                            <hr />
                            <template is="dom-repeat" items="[[cards]]">
                                <table class="card-table">
                                    <tr>
                                        <td>
                                            <img src="{{getCardImage(item.editions)}}" alt="[[item.name]]" />
                                            <p>Illus. [[getCardArtist(item.editions)]]</p>
                                        </td>
                                        <td>
                                            <div class$="[[getCardColor(item.colors)]]">
                                                <h2>[[item.name]]</h2>
                                                <p>
                                                    <template is="dom-repeat" items="[[item.supertypes]]">
                                                        [[item]]
                                                    </template>
                                                    <template is="dom-repeat" items="[[item.types]]">
                                                        [[item]]
                                                    </template>
                                                    <template is="dom-if" if="[[item.subtypes]]">
                                                        - 
                                                        <template is="dom-repeat" items="[[item.subtypes]]">
                                                            [[item]]
                                                        </template>
                                                    </template>
                                                </p>
                                                <div class="card-text-container">
                                                    <span class="card-text">[[item.text]]</span>
                                                </div>
                                                <template is="dom-if" if="[[hasCardFlavor(item.editions)]]">
                                                    <div class="card-flavor-container">
                                                        <span class="card-flavor">[[getCardFlavor(item.editions)]]</span>
                                                    </div>
                                                </template>
                                                <button class="add-to-deck" on-tap="_addCardToDeck">Add To Deck</button>
                                            </div>
                                            
                                        </td>
                                        <td>
                                            <div class="card-data-container">
                                                <ul>
                                                    <template is="dom-if" if="[[item.loyalty]]">
                                                        <li>
                                                            <em>Loyalty:</em> [[item.loyalty]]
                                                        </li>
                                                    </template>
                                                    <template is="dom-if" if="[[item.power]]">
                                                        <li>
                                                            <em>P/T:</em> [[item.power]]/[[item.toughness]]
                                                        </li>
                                                    </template>
                                                    <li>
                                                        <template is="dom-if" if="[[item.cost]]">
                                                            Cost: [[item.cost]]
                                                        </template>
                                                        <template is="dom-if" if="[[!item.cost]]">
                                                            Cost: 0
                                                        </template>
                                                    </li>
                                                    <li>
                                                        <em>CMC:</em> [[item.cmc]]
                                                    </li>
                                                    <br />
                                                    <li>
                                                        Editions:
                                                        <ul>
                                                            <template is="dom-repeat" items="[[item.editions]]">
                                                                <li>
                                                                    [[item.set]] - [[item.set_id]] ([[item.rarity]])
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </li>
                                                    <br />
                                                    <li>
                                                        Legal Formats:
                                                        <ul>
                                                            <template is="dom-if" if="[[item.formats.standard]]">
                                                                <li>
                                                                    standard - [[item.formats.standard]]
                                                                </li>
                                                            </template>
                                                            <template is="dom-if" if="[[item.formats.modern]]">
                                                                <li>
                                                                    modern - [[item.formats.modern]]
                                                                </li>
                                                            </template>
                                                            <template is="dom-if" if="[[item.formats.legacy]]">
                                                                <li>
                                                                    legacy - [[item.formats.legacy]]
                                                                </li>
                                                            </template>
                                                            <template is="dom-if" if="[[item.formats.vintage]]">
                                                                <li>
                                                                    vintage - [[item.formats.vintage]]
                                                                </li>
                                                            </template>
                                                            <template is="dom-if" if="[[item.formats.commander]]">
                                                                <li>
                                                                    commander - [[item.formats.commander]]
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                                <hr />
                            </template>
                        </template>
                    </template>
                    <template is="dom-if" if="[[error_]]">
                        <h1>AN ERROR HAS OCCURED. Please retry your search or reload the page.</h1>
                    </template>
                </template>
                <!-- 
                    -------------------------
                        DECK BUILDER VIEW 
                    -------------------------
                                             --->
                <template is="dom-if" if="{{_viewIsBuild(view)}}">
                    <template is="dom-if" if="[[deckIsEmpty(deck)]]">
                        <h2>The deck is empty.</h2>
                        <span> Cards added to the deck on the Fetch page will show up here.</span>
                    </template>
                    <template is="dom-if" if="[[!deckIsEmpty(deck)]]">
                        <div id="deck-container">
                            <template id="deck-template" is="dom-repeat" items="[[deck]]">
                                <div class="deck-card">
                                    <img src="[[getCardImage(item.card.editions)]]" alt="[[item.card.name]]" />
                                    <br />
                                    <div id="add-remove">
                                        <button class="pretty-button" value="[[item.card.name]]" on-tap="_removeCard">-</button>
                                        <span id="card-amount">{{item.amount}}</span>
                                        <button class="pretty-button" value="[[item.card.name]]" on-tap="_addCard">+</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div id="deck-stats">
                            [[updateStats()]]
                            <h2 style="text-align: center; text-decoration: underline;">Deck Stats</h2>
                            <ul>
                                <li>Cards in Deck: [[numcards]] stats: [[stats.numCards]]</li>
                                <br />
                                <li>Colors of Cards: 
                                    <ul>
                                        <template is="dom-repeat" items="[[getColorArray(stats.colors)]]" filter="filterColor">
                                            <li>[[item.color]]: [[item.amount]]</li>
                                        </template>
                                    </ul>
                                </li>
                                <br />
                                <li>Card Types: 
                                    <ul>
                                        <template is="dom-repeat" items="[[getTypeArray(stats.types)]]" filter="filterType">
                                            <li>[[item.type]]: [[item.amount]]</li>
                                        </template>
                                    </ul>
                                </li>
                                <br />
                                <li>
                                    Average Converted Mana Cost: [[stats.averageCMC]]
                                </li>
                                <br />
                                <li>Mana Curve: 
                                    <ul>
                                        <template is="dom-repeat" items="[[getCMCArray(stats.cmcList)]]" >
                                            <template is="dom-if" if="[[hasCMC(item)]]">
                                                <li>[[index]]: [[item]]</li>
                                            </template>
                                        </template>
                                    </ul>
                                </li>
                            </ul>
                            <div id="button-wrap">
                                <button class="pretty-button" on-tap="_clearDeck">Clear Deck</button>
                            </div>
                        </div>
                    </template>
                </template>
                <!-- 
                    ------------------
                        DRAFT VIEW 
                    ------------------
                                      --->
                <template is="dom-if" if="{{_viewIsDraft(view)}}">
                    <form id="draft-form" on-submit="_getBooster">
                        <select class="pretty-dropdown" id="draft-select">
                            <option value="SOI">Shadows over Innistrad</option>
                            <option value="OGW">Oath of the Gatewatch</option>
                            <option value="BFZ">Battle for Zendikar</option>
                            <option value="ORI">Magic Origins</option>
                            <option value="DTK">Dragons of Tarkir</option>
                            <option value="FRF">Fate Reforged</option>
                            <option value="KTK">Khans of Tarkir</option>
                        </select>
                        <button class="pretty-button" id="booster" on-tap="_getBooster">Open Booster</button>
                        <button class="pretty-button" id="clear-picks" on-tap="clearPicks" style="float: right;">Clear Picks and Reset Draft</button>
                    </form>
                    <template is="dom-if" if="[[!display_]]">
                        <template is="dom-if" if="[[!loading_]]">
                            <h2>No booster is opened</h2>
                            <span>Choose a set and open a boosterpack</span>
                        </template>
                        <template is="dom-if" if="[[loading_]]">
                            <h1 style="text-align: center;">Loading Booster</h1>
                            <div class="loader">LOADING BOOSTER...</div>
                        </template> 
                    </template>
                    <template is="dom-if" if="[[display_]]">
                        <h2>Booster Contents</h2>
                        <span>Click a card to select it</span>
                        <br>
                        <template is="dom-if" if="[[ready_]]">
                            <div id="booster-container">
                                <template id="boosterDisplay" is="dom-repeat" items="[[booster]]" filter="filterIndex" as="packs">
                                    <template is="dom-repeat" items="[[packs.pack.cards]]">
                                        <div  class="booster-card">
                                            <img src="[[item.imageUrl]]" alt="[[item.name]]" on-tap="_pickCard"/>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </template>
                        <hr />
                        <h2>Selected Cards</h2>
                        <div id="picks-container">
                            <template is="dom-repeat" items="[[picks]]">
                                <div  class="picks-card">
                                    <img src="[[item.imageUrl]]" alt="[[item.name]]"/>
                                </div>
                            </template> 
                        </div>
                    </template>
                </template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "mtg-card-fetcher",
           
            properties: {
                params: {
                    type: Array,
                    value: ["search-field","rules-text","super-type","card-type","sub-type",
                            "color-white","color-blue","color-black","color-red","color-green",
                            "color-multi","rarity-mythic","rarity-rare","rarity-uncommon",
                            "rarity-common","rarity-basic","rarity-special","set","format-select"]
                },
                
                filters: {
                    type: Array,
                    value: ["name=","oracle=","supertype=","type=","subtype=","color=","color=",
                            "color=","color=","color=","multicolor=","rarity=","rarity=","rarity=",
                            "rarity=","rarity=","rarity=","set=","format="]
                },
                
                cards:  {
                    type: Object
                },
                
                booster:    {
                    type: Array,
                    value: []
                },
                
                index: {
                    type: Number,
                    value: 0  
                },
                
                picks:  {
                    type: Object,
                    value: []
                },
                
                deck:   {
                    type: Array,
                    value: []
                },
                
                stats:  {
                    type: Object,
                    value: {numCards: 0, colors: {}, types: {}, cmcList: {}, averageCMC: 0 }
                },
                
                view:   {
                    type: String,
                    default: "search"  
                },
                
                loading_:   {
                    type: Boolean,
                    value: false
                },
                
                ready_: {
                    type: Boolean,
                    value: false
                },
                
                error_: {
                    type: Boolean,
                    value: false
                },
                
                display_: {
                    type: Boolean,
                    value: false
                }
            }, 
           
            attached: function() {
                this.retrieveDeck();
            },
            
            _searchForCards: function(e) {
                e.preventDefault();
                this.ready_ = false;
                this.loading_ = true;
                this.error_ = false;
                var search = "";
                for(var i = 0; i < this.params.length; i++)
                {
                    if(this.$$('#' + this.params[i]).type !== "checkbox" && this.$$('#' + this.params[i]).value !== "")
                    {
                        if(i > 0 && search !== "")
                        {
                            search = search + "&";
                        }
                        search = search + this.filters[i];
                        search = search + this.$$('#' + this.params[i]).value;
                    }
                    else if(this.$$('#' + this.params[i]).type === "checkbox" && this.$$('#' + this.params[i]).checked)
                    {
                        if(i > 0 && search !== "")
                        {
                            search = search + "&";
                        }
                        
                        search = search + this.filters[i];
                        search = search + this.$$('#' + this.params[i]).value;
                    }
                    
                }
                this.loadCards_(search);
            },
            
            _toggleForm: function(e)    {
                e.preventDefault();
                if(this.$$('#advanced-div').style.cssText  === "display: none;")
                {
                    this.$$('#advanced-div').style.cssText = "display: block";
                }
                else if(this.$$('#advanced-div').style.cssText  === "display: block;")
                {
                    this.$$('#advanced-div').style.cssText = "display: none";
                }
            },
            
            _addCard: function(e)   {
                e.preventDefault();
                for(var i = 0; i < this.deck.length; i++)
                {
                    if(e.model.__data__.item.card.name === this.deck[i].card.name)
                    {
                        this.set('deck.' + i + '.amount', this.deck[i].amount + 1);
                        this.storeDeck();
                        this.updateStats();
                        //this.set('stats.numCards', this.stats.numCards + 1); 
                        
                    }
                }     
            },
            
            _removeCard: function(e)    {
                e.preventDefault();
                for(var i = 0; i < this.deck.length; i++)
                {
                    if(e.model.__data__.item.card.name === this.deck[i].card.name)
                    {
                        this.set('deck.' + i + '.amount', this.deck[i].amount - 1);
                        //this.set('stats.numCards', this.stats.numCards - 1); 
                        if(this.deck[i].amount === 0)
                        {
                            this.splice('deck',i,1);
                        }
                        this.storeDeck();
                        this.updateStats();
                    }
                }     
            },
            
            filterIndex: function(item) {
                if(item.index === this.index) {
                    return true;
                } else {
                    return false;
                }
            },
            
            filterDeck: function(item) {
                return true;
            },
            
            filterColor: function(item) {
                if(item.amount > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }  
            },
            
            filterType: function(item) {
                if(item.amount > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            },
            
            filterCMC: function(item) {
                if(item > 0)
                {
                    return true;
                }  
                else
                {
                    return false;
                }
            },
            
            _clearDeck: function(e) {
                this.splice('deck', 0, this.deck.length+1);
                localStorage.clear();
                this.updateStats();
            },
            
            clearPicks: function(e) {
                e.preventDefault();
                this.index = 0;
                this.display_ = false;
                this.picks = [];  
                this.booster = [];
            },
            
            _addCardToDeck: function(e) {
                //take card from clicked event and add it to deck
                e.preventDefault();
                var id = 0;
                
                var inDeck = false;
                for(var i = 0; i < this.deck.length; i++)
                {
                    if(this.deck[i].card.name == e.model.__data__.item.name)
                    {
                        inDeck = true;
                        break;
                    }
                }
                if(!inDeck) 
                {
                    var card = {
                        card: e.model.__data__.item,
                        amount: 1
                    };
                
                    this.push('deck', card);
                    this.storeDeck();
                    this.updateStats();            
                }
            },
           
            loadCards_: function (search)     {
                var self = this;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "https://api.deckbrew.com/mtg/cards?" + search, true);
               
                xhr.onload = function(evt)   {
                    if(xhr.status === 200)   {
                        self.cards = JSON.parse(xhr.responseText);
                        self.loading_ = false;
                        self.ready_ = true;
                    } else  {
                        self.error_ = true;
                        self.loading_ = false;
                        self.ready_ = false;   
                    }
                };
                xhr.send();
            },
            
            _getBooster: function (e)    {
                e.preventDefault();
                this.booster = [];
                this.display_ = false;
                this.ready_ = false;
                this.loading_ = true;
                var set = this.$$('#draft-select').value;
                
                for(var i = 0; i < 8; i++)
                {
                    this.loadBooster(set);
                }
            },
            
            loadBooster: function(set)     {
                var self = this;
                var xhr = new XMLHttpRequest();
                
                xhr.open("GET", "https://api.magicthegathering.io/v1/sets/" + set + "/booster", true);
                
                xhr.onload = function(evt)   {
                    if(xhr.status === 200)   {
                        self.push('booster', {pack: JSON.parse(xhr.responseText), index: self.booster.length});
                        if(self.booster.length === 8)
                        {
                            self.loading_ = false;
                            self.ready_ = true;
                            self.display_ = true;
                        }
                    } else  {
                        self.error_ = true;
                        self.loading_ = false;
                        self.ready_ = false;   
                    }
                };
                
                xhr.send();
            },
            
            _pickCard: function(e)    {
                e.preventDefault();
                
                for(var i = 0; i < this.booster[this.index].pack.cards.length; i++)
                {
                    if(e.model.__data__.item.name === this.booster[this.index].pack.cards[i].name)
                    {
                        this.booster[this.index].pack.cards.splice(i,1);
                    }
                }   
                this.push('picks', e.model.__data__.item);
                
                this.aiPick();
                this.rotateBooster();
            },
            
            rotateBooster: function() {
                if(this.index < 7) {
                    this.index++;
                } else {
                    this.index = 0
                }
                this.display_ = false;
                this.loading_ = true;
                
                this.$$('#boosterDisplay').render();
                
                this.display_ = true;
                this.loading_ = false;
            },
            
            aiPick: function() {
                for(var i = 0; i < 8; i++)
                {
                    if(i !== this.index) {
                        this.booster[i].pack.cards.splice(0,1);
                    }
                }
            },
                           
            _viewIsSearch: function (v)  {
                return v === 'search';
            },
            
            _viewIsBuild: function (v)  {
                return v === 'build';
            },
            
            _viewIsDraft: function (v)  {
                return v === 'draft';
            },
            
            updateStats: function() {
                  
                  this.updateNumCards();
                  this.updateColors();
                  this.updateTypes();
                  this.updateAverageCMC();
                  this.updateCMC();
            },
            
            updateNumCards: function()  {
                var cardCount = 0; 
                for(var i = 0; i < this.deck.length; i++)
                {
                    cardCount += this.deck[i].amount;
                }  
                
                this.set('stats.numCards', cardCount);
            },
            
            updateColors: function() {
                this.set('stats.colors', this.getDeckColors());
            },
            
            updateTypes: function() {
                this.set('stats.types', this.getDeckTypes());
            },
            
            updateAverageCMC: function () {
                var totalCMC = 0;
                var cardCount = 0;
                var landFlag = false;
                for(var i = 0; i < this.deck.length; i++)
                {
                    for(var j = 0; j < this.deck[i].card.types.length; j++)
                    {
                        if(this.deck[i].card.types[j] === "land") {
                            console.log(this.deck[i].card.name);
                            landFlag = true;
                        }
                    }
                    if(this.deck[i].card.cmc !== undefined && !landFlag)
                    {
                        cardCount += this.deck[i].amount;
                        totalCMC += (this.deck[i].card.cmc * this.deck[i].amount)
                    } else if(landFlag) {
                        landFlag = false;
                    }
                }
                
                this.set('stats.averageCMC', (totalCMC / cardCount).toFixed(2));
            },
            
            updateCMC: function () {
                this.set('stats.cmcList', this.getDeckCMC());  
            },
            
            getCardImage: function (editions) {
                for(var i = 0; i < editions.length; i++)    
                {
                    if(editions[i].image_url && editions[i].image_url !== "https://image.deckbrew.com/mtg/multiverseid/0.jpg")
                    {
                        return editions[i].image_url;
                    }
                }
            },
            
            getCardArtist: function (editions) {
                for(var i = 0; i < editions.length; i++)    
                {
                    if(editions[i].image_url && editions[i].image_url !== "https://image.deckbrew.com/mtg/multiverseid/0.jpg")
                    {
                        return editions[i].artist;
                    }
                }
            },
            
            getCardFlavor: function (editions) {
                for(var i = 0; i < editions.length; i++)    
                {
                    if(editions[i].image_url !== "https://image.deckbrew.com/mtg/multiverseid/0.jpg")
                    {
                        return editions[i].flavor;
                    }
                }
            },
            
            hasCardFlavor: function (editions) {
                for(var i = 0; i < editions.length; i++)    
                {
                    if(editions[i].image_url !== "https://image.deckbrew.com/mtg/multiverseid/0.jpg" && editions[i].flavor)
                    {
                        return true;
                    }
                }
                
                return false;
            },
            
            getCardColor: function (colors) {
                
                if(colors == undefined)
                {
                    return "card-description-container";
                }
                else if(colors.length > 1)
                {
                    return "card-description-container-gold";
                }
                else if(colors[0] === "white")
                {
                    return "card-description-container-white";
                }
                else if(colors[0] === "blue")
                {
                    return "card-description-container-blue";
                }
                else if(colors[0] === "black")
                {
                    return "card-description-container-black";
                }
                else if(colors[0] === "red")
                {
                    return "card-description-container-red";
                }
                else if(colors[0] === "green")
                {
                    return "card-description-container-green";
                }
            },
            
            getDeckColors: function () {
                //return an array with the number of cards of each color in the deck
                var colors = {
                    white: 0,
                    blue: 0,
                    black: 0,
                    red: 0,
                    green: 0,
                    colorless: 0                  
                };
                
                for(var i = 0; i < this.deck.length; i++)
                {
                    if(this.deck[i].card.colors === undefined)
                    {
                        colors.colorless += this.deck[i].amount;
                    }
                    else
                    {
                        for(var j = 0; j < this.deck[i].card.colors.length; j++)
                        {
                            if(this.deck[i].card.colors[j] === "white")
                            {
                                colors.white += this.deck[i].amount;
                            }
                            else if(this.deck[i].card.colors[j] === "blue")
                            {
                                colors.blue += this.deck[i].amount;
                            }
                            else if(this.deck[i].card.colors[j] === "black")
                            {
                                colors.black += this.deck[i].amount;
                            }
                            else if(this.deck[i].card.colors[j] === "red")
                            {
                                colors.red += this.deck[i].amount;
                            }
                            else if(this.deck[i].card.colors[j] === "green")
                            {
                                colors.green += this.deck[i].amount;
                            }
                        }
                    }
                }
                
                return colors;
            },
            
            getColorArray: function(colors) {
                
                colorArray = [];
                
                colorArray.push({color:"white", amount: colors.white});
                colorArray.push({color:"blue", amount: colors.blue});
                colorArray.push({color:"black", amount: colors.black});
                colorArray.push({color:"red", amount: colors.red});
                colorArray.push({color:"green", amount: colors.green});
                colorArray.push({color:"colorless", amount: colors.colorless});
                
                return colorArray;  
            },
            
            getDeckTypes: function () {
                //return an array of the number of cards of each type in the deck
                var types = {
                    artifact: 0,
                    creature: 0,
                    enchantment: 0,
                    instant: 0,
                    land: 0,
                    phenomenon: 0,
                    plane: 0,
                    planeswalker: 0,
                    scheme: 0,
                    sorcery: 0,
                    tribal: 0,
                    vanguard: 0    
                };
                
                for(var i = 0; i < this.deck.length; i++)
                {    
                    for(var j = 0; j < this.deck[i].card.types.length; j++)
                    {
                        if(this.deck[i].card.types[j] === "artifact")
                        {
                            types.artifact += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "creature")
                        {
                            types.creature += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "enchantment")
                        {
                            types.enchantment += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "instant")
                        {
                            types.instant += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "land")
                        {
                            types.land += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "phenomenon")
                        {
                            types.phenomenon += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "plane")
                        {
                            types.plane += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "planeswalker")
                        {
                            types.planeswalker += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "scheme")
                        {
                            types.scheme += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "sorcery")
                        {
                            types.sorcery += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "tribal")
                        {
                            types.tribal += this.deck[i].amount;
                        }
                        else if(this.deck[i].card.types[j] === "vanguard")
                        {
                            types.vanguard += this.deck[i].amount;
                        }
                        
                    }
                }   
                
                return types;
            },
            
            getTypeArray: function(types) {
                
                typeArray = [];
                
                typeArray.push({type:"artifact", amount: types.artifact});
                typeArray.push({type:"creature", amount: types.creature});
                typeArray.push({type:"enchantment", amount: types.enchantment});
                typeArray.push({type:"instant", amount: types.instant});
                typeArray.push({type:"land", amount: types.land});
                typeArray.push({type:"phenomenon", amount: types.phenomenon});
                typeArray.push({type:"plane", amount: types.plane});
                typeArray.push({type:"planeswalker", amount: types.planeswalker});
                typeArray.push({type:"scheme", amount: types.scheme});
                typeArray.push({type:"sorcery", amount: types.sorcery});
                typeArray.push({type:"tribal", amount: types.tribal});
                typeArray.push({type:"vanguard", amount: types.vanguard});
                
                return typeArray;
            },
            
            getDeckCMC: function () {
                //return an array of the number of cards of each Converted Mana Cost in the deck
                var cmc = {};
                
                for(var i = 0; i <= 16; i++)
                {
                    cmc[i] = 0;
                }
                
                var landFlag = false;
                for(var i = 0; i < this.deck.length; i++)
                {
                    for(var j = 0; j < this.deck[i].card.types.length; j++)
                    {
                        if(this.deck[i].card.types[j] === "land") {
                            landFlag = true;
                        }
                    }
                    if(!landFlag) {
                        cmc[this.deck[i].card.cmc] += this.deck[i].amount;
                    } else {
                        landFlag = false;
                    }
                }
                
                return cmc;
            },
            
            getCMCArray: function(cmcList) {
                cmcArray = []
                
                for(var i = 0; i < 16; i++)
                {
                    cmcArray[i] = cmcList[i];
                }
                
                return cmcArray;
            },
            
            hasCMC: function(i) {
                if(i > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            },   
            
            getNumResults: function(cards) {
                return cards.length;
            },
            
            cardsIsEmpty: function(cards) {
                if(cards.length === 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            },
            
            deckIsEmpty: function(deck) {
                if(deck.length === 0)
                {
                    return true;
                } 
                else
                {
                    return false;
                }
            },
            
            storeDeck: function () {
                //put deck into local storage
                if(typeof(Storage) !== "undefined") 
                {
                    localStorage.setItem("deck", JSON.stringify(this.deck));
                }
                else
                {
                    console.log("This browser doesn't support Local Storage");
                }
            },
            
            retrieveDeck: function () {
                //retrieve deck from local storage
                if(typeof(Storage) !== "undefined") 
                {
                    if(localStorage.getItem("deck") === null)
                    {
                        console.log("No deck in Local Storage");
                    }
                    else
                    {
                        this.deck = JSON.parse(localStorage.getItem("deck"));
                        console.log("Deck Loaded from Local Storage");
                    }
                }
                else
                {
                    console.log("This browser doesn't support Local Storage");
                }
            }
            
        });
    </script>
</dom-module>
        